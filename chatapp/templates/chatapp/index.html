{% extends 'base.html' %}
{% block extra_js %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    {% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'chatapp/style.css' %}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Styles remain unchanged from the original file */
        body, html { height: 100%; margin: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #eef2f7; color: #333; }
        .chat-container { display: flex; flex-direction: column; height: 90vh; max-width: 1000px; margin: 20px auto; background-color: #ffffff; border-radius: 16px; box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15); overflow: hidden; }
        .chat-header { padding: 15px; background-color: #007bff; color: #ffffff; text-align: center; font-size: 1.7em; font-weight: bold; position: relative; }
        .messages-box { flex: 1; overflow-y: auto; padding: 20px; background-color: #f4f8fc; }
        .message { display: flex; align-items: flex-start; margin-bottom: 15px; transition: transform 0.3s; }
        .message.sent { justify-content: flex-end; }
        .message.received { justify-content: flex-start; }
        .message-text { max-width: 80%; padding: 15px; border-radius: 12px; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1); font-size: 1em; line-height: 1.5; }
        .message.sent .message-text { background-color: #007bff; color: #ffffff; border-radius: 12px 12px 0 12px; }
        .message.received .message-text { background-color: #e9f5ff; color: #333; border-radius: 12px 12px 12px 0; }
        .message-timestamp { font-size: 0.75em; color: #9a9a9a; margin-top: 5px; text-align: right; }
        .message-form { background-color: #fff; border-top: 1px solid #dddfe2; padding: 10px; }
        .btn-send:hover { background-color: #0056b3; }
        .message-input { resize: none; border: none; background-color: #f0f2f5; border-radius: 20px; padding-left: 15px; height: 40px; }
        .message-input:focus { background-color: #fff; border: none; box-shadow: none; }
        .btn-send { border: none; background-color: #0084ff; color: #fff; border-radius: 50%; width: 40px; height: 40px; }
        .btn-send i { margin-left: -2px; }
        .typing-indicator { display: none; font-style: italic; color: #999; text-align: center; margin-top: 10px; }
        .reset-button { position: absolute; top: 15px; right: 15px; }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            AI Assistant
            <button class="btn btn-danger reset-button" id="clear-history-button">Reset History</button>
        </div>
        <div class="messages-box">
            <ul class="list-unstyled messages-list">
                <li class="message received">
                    <div class="message-text">
                        <b>AI Chatbot</b>
                        <div class="message-content">Hi there! How can I help with your studies today?</div>
                        <div class="message-timestamp">{{ now|date:"H:i:s" }}</div>
                    </div>
                </li>
                <li class="typing-indicator">AI Chatbot is typing...</li>
            </ul>
        </div>
        <form class="message-form" id="userInput">
            {% csrf_token %}
            <div class="input-group">
                <input type="text" class="form-control message-input" id="textInput" placeholder="Type your message...">
                <button type="submit" class="btn btn-primary btn-send">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </form>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.25.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', (event) => {
            const clearHistoryButton = document.getElementById('clear-history-button');
    
            clearHistoryButton.addEventListener('click', () => {
                fetch("{% url 'chatapp:clear_chatbot_history' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Clear history response:', data);
                    if (data.status === 'success') {
                        // Optionally, clear the chatbox UI
                        const messagesList = document.getElementById('messages-list');
                        messagesList.innerHTML = '';
                    } else {
                        console.error('Failed to clear history:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            });
        });
    </script>

    <!-- External JavaScript files -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
          const messageForm = document.querySelector('.message-form');
          const messageInput = document.querySelector('.message-input');
          const messagesList = document.querySelector('.messages-list');
          const typingIndicator = document.querySelector('.typing-indicator');
          
          // CSRF token function
          function getCookie(name) {
              let cookieValue = null;
              if (document.cookie && document.cookie !== '') {
                  const cookies = document.cookie.split(';');
                  for (let i = 0; i < cookies.length; i++) {
                      const cookie = cookies[i].trim();
                      if (cookie.substring(0, name.length + 1) === (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
                  }
              }
              return cookieValue;
          }
          
          // Function to send and display message
          function sendMessage() {
              const userMessage = messageInput.value.trim();
              if (!userMessage) return;
          
              // Display user's message in the chatbox
              const userMessageItem = document.createElement('li');
              userMessageItem.classList.add('message', 'sent');
              userMessageItem.innerHTML = `
                  <div class="message-text">
                      <b>You</b>
                      <div class="message-content">${userMessage}</div>
                      <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
                  </div>`;
              messagesList.appendChild(userMessageItem);
              messageInput.value = '';
          
              // Show typing indicator
              typingIndicator.style.display = 'block';
          
              // Send user input to the backend
              fetch("{% url 'chatapp:getUserResponse' %}", {
                  method: "POST",
                  headers: {
                      "Content-Type": "application/json",
                      "X-CSRFToken": getCookie('csrftoken')
                  },
                  body: JSON.stringify({ message: userMessage })
              })
              .then(response => response.json())
              .then(data => {
                  typingIndicator.style.display = 'none';
                  const responseText = data.response || 'No response from bot';
                  // Display bot's response in the chatbox
                  const chatbotMessageItem = document.createElement('li');
                  chatbotMessageItem.classList.add('message', 'received');
                  chatbotMessageItem.innerHTML = `
                      <div class="message-text">
                          <b>AI Chatbot</b>
                          <div class="message-content">${responseText}</div>
                          <div class="message-timestamp">${new Date().toLocaleTimeString()}</div>
                      </div>`;
                  messagesList.appendChild(chatbotMessageItem);
              })
              .catch(error => {
                  typingIndicator.style.display = 'none';
                  console.error('Error:', error);
              });
          }
          
          messageForm.addEventListener('submit', (event) => {
              event.preventDefault();
              sendMessage();
          });
        });
    </script>
</body>
</html>
{% endblock %}
