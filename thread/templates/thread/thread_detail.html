{% extends 'base.html' %}

{% load static %}

{% block title %}{{ thread.thread_title }}{% endblock %}

{% block header %}
<div class="container-fluid bg-gradient py-3">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="text-white mb-0">
                <i class="fas fa-comment-alt me-2"></i>Thread Details
            </h3>
            <a href="{% url 'thread:thread_list' %}" class="btn btn-light">
                <i class="fas fa-arrow-left me-1"></i>Back to Threads
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Thread Card -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h4 class="card-title mb-1">{{ thread.thread_title }}</h4>
                    <p class="text-muted small mb-0">
                        {% if thread.is_anonymous %}
                            {% if request.user.is_staff or request.user.is_superuser %}
                                <strong>Anonymous (Actually: @{{ thread.created_by.username }})</strong>
                            {% else %}
                                <strong>Anonymous</strong>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'user:user_detail' thread.created_by.pk %}" class="text-decoration-none">
                                <strong>@{{ thread.created_by.username }}</strong>
                            </a>
                        {% endif %}
                        · 
                        <span>{{ thread.created|date:"M d, Y H:i" }}</span>
                    </p>
                </div>
                <!-- Thread Actions -->
            </div>

            <!-- Thread Content -->
            <div class="thread-content mb-3">
                {{ thread.thread_content }}
            </div>

            {% if thread.image %}
            <div class="thread-image mb-3">
                <img src="{{ thread.image.url }}" alt="Thread Image" class="img-fluid rounded">
            </div>
            {% endif %}

            <!-- Reactions -->
            <div class="reactions-container mb-3">
                <form method="post" action="{% url 'thread:react_to_thread' thread.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="reaction_type" value="like" class="btn btn-reaction">
                        <i class="fas fa-thumbs-up text-primary"></i>
                        <span class="reaction-count">{{ likes_count }}</span>
                    </button>
                </form>
                <form method="post" action="{% url 'thread:react_to_thread' thread.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="reaction_type" value="love" class="btn btn-reaction">
                        <i class="fas fa-heart text-danger"></i>
                        <span class="reaction-count">{{ loves_count }}</span>
                    </button>
                </form>
                <form method="post" action="{% url 'thread:react_to_thread' thread.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="reaction_type" value="haha" class="btn btn-reaction">
                        <i class="fas fa-laugh-squint text-warning"></i>
                        <span class="reaction-count">{{ haha_count }}</span>
                    </button>
                </form>
                <form method="post" action="{% url 'thread:react_to_thread' thread.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="reaction_type" value="wow" class="btn btn-reaction">
                        <i class="fas fa-surprise text-purple"></i>
                        <span class="reaction-count">{{ wow_count }}</span>
                    </button>
                </form>
                <form method="post" action="{% url 'thread:react_to_thread' thread.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="reaction_type" value="sad" class="btn btn-reaction">
                        <i class="fas fa-sad-tear text-secondary"></i>
                        <span class="reaction-count">{{ sad_count }}</span>
                    </button>
                </form>
                <form method="post" action="{% url 'thread:react_to_thread' thread.pk %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" name="reaction_type" value="angry" class="btn btn-reaction">
                        <i class="fas fa-angry text-orange"></i>
                        <span class="reaction-count">{{ angry_count }}</span>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-gradient">
            <h5 class="text-white mb-0">
                <i class="fas fa-comments me-2"></i>Comments
            </h5>
        </div>
        <div class="card-body p-0">
            <!-- Comments List Box -->
            <div class="comments-scroll-box">
                {% for item in comments_with_reactions %}
                <div class="comment-card">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="user-info">
                            <strong>{{ item.comment.user.username }}</strong>
                            <small class="text-muted">· {{ item.comment.created|date:"M d, Y H:i" }}</small>
                        </div>
                        {% if request.user == item.comment.user or request.user.is_superuser %}
                        <div class="action-buttons">
                            <a href="{% url 'thread:update_comment' thread.pk item.comment.pk %}" 
                               class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-edit"></i>
                            </a>
                            <a href="{% url 'thread:delete_comment' thread.pk item.comment.pk %}" 
                               class="btn btn-outline-danger btn-sm ms-2"
                               onclick="return confirm('Delete this comment?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <div class="comment-content mb-2">
                        {{ item.comment.comment_text }}
                        {% if item.comment.image %}
                        <div class="comment-image-container">
                            <img src="{{ item.comment.image.url }}" alt="Comment Image" 
                                 class="comment-img rounded">
                        </div>
                        {% endif %}
                    </div>

                    <!-- Comment Reactions -->
                    <div class="reactions-container">
                        <form method="post" action="{% url 'thread:react_to_comment' item.comment.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" name="reaction_type" value="like" class="btn btn-reaction btn-sm">
                                <i class="fas fa-thumbs-up text-primary"></i>
                                <span class="reaction-count">{{ item.comment_likes_count }}</span>
                            </button>
                        </form>

                        <form method="post" action="{% url 'thread:react_to_comment' item.comment.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" name="reaction_type" value="love" class="btn btn-reaction btn-sm">
                                <i class="fas fa-heart text-danger"></i>
                                <span class="reaction-count">{{ item.comment_loves_count }}</span>
                            </button>
                        </form>

                        <form method="post" action="{% url 'thread:react_to_comment' item.comment.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" name="reaction_type" value="haha" class="btn btn-reaction btn-sm">
                                <i class="fas fa-laugh-squint text-warning"></i>
                                <span class="reaction-count">{{ item.comment_haha_count }}</span>
                            </button>
                        </form>

                        <form method="post" action="{% url 'thread:react_to_comment' item.comment.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" name="reaction_type" value="wow" class="btn btn-reaction btn-sm">
                                <i class="fas fa-surprise text-purple"></i>
                                <span class="reaction-count">{{ item.comment_wow_count }}</span>
                            </button>
                        </form>

                        <form method="post" action="{% url 'thread:react_to_comment' item.comment.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" name="reaction_type" value="sad" class="btn btn-reaction btn-sm">
                                <i class="fas fa-sad-tear text-secondary"></i>
                                <span class="reaction-count">{{ item.comment_sad_count }}</span>
                            </button>
                        </form>

                        <form method="post" action="{% url 'thread:react_to_comment' item.comment.pk %}" class="d-inline">
                            {% csrf_token %}
                            <button type="submit" name="reaction_type" value="angry" class="btn btn-reaction btn-sm">
                                <i class="fas fa-angry text-orange"></i>
                                <span class="reaction-count">{{ item.comment_angry_count }}</span>
                            </button>
                        </form>
                    </div>
                </div>
                {% empty %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <p>No comments yet. Be the first to comment!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Post Comment Box -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-gradient">
            <h5 class="text-white mb-0">
                <i class="fas fa-reply me-2"></i>Post a Comment
            </h5>
        </div>
        <div class="card-body">
            <form method="post" action="{% url 'thread:add_comment' thread.pk %}" 
                  enctype="multipart/form-data" class="comment-form">
                {% csrf_token %}
                <div class="mb-3">
                    <textarea class="form-control" name="comment_text" rows="3" 
                              placeholder="Write your comment..." required></textarea>
                </div>
                <div class="d-flex justify-content-between align-items-center">
                    <div class="image-upload">
                        <label for="image" class="btn btn-outline-secondary">
                            <i class="fas fa-image me-1"></i>Add Image
                        </label>
                        <input type="file" id="image" name="image" class="d-none" 
                               accept="image/*" onchange="previewImage(event)">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-1"></i>Post Comment
                    </button>
                </div>
                <div id="image-preview-container" class="mt-3 d-none position-relative">
                    <img id="image-preview" class="preview-image">
                    <button type="button" class="btn-remove-preview" onclick="removePreview()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Back to Thread Button -->
    <div class="text-center mb-4">
        <a href="{% url 'thread:thread_list' %}" class="btn btn-back">
            <i class="fas fa-arrow-left me-2"></i>Back to Threads
        </a>
    </div>
</div>

<style>
    .bg-gradient {
        background: linear-gradient(45deg, #2c3e50, #3498db);
    }

    .card {
        border: none;
        border-radius: 12px;
    }

    .thread-content {
        font-size: 1.1rem;
        line-height: 1.6;
    }

    .comment-card {
        padding: 1rem;
        border-radius: 8px;
        background: #f8f9fa;
        border: 1px solid #e9ecef;
    }

    .reactions-container {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .btn-reaction {
        padding: 8px 16px;
        border-radius: 20px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #2c3e50;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .btn-reaction:hover {
        background: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-reaction i {
        font-size: 1.1rem;
    }

    .reaction-count {
        font-size: 0.9rem;
        font-weight: 600;
    }

    .text-purple { color: #9b59b6; }
    .text-orange { color: #e67e22; }

    /* For comment reactions, make them slightly smaller */
    .comment-card .btn-reaction {
        padding: 6px 12px;
        font-size: 0.9rem;
    }

    .comment-card .btn-reaction i {
        font-size: 1rem;
    }

    /* Header Gradient */
    .bg-gradient {
        background: linear-gradient(45deg, #2c3e50, #3498db);
    }

    /* Comments Scroll Box */
    .comments-scroll-box {
        max-height: 500px;
        overflow-y: auto;
        padding: 1rem;
    }

    /* Comment Images */
    .comment-image-container {
        margin-top: 1rem;
    }

    .comment-img {
        max-width: 200px;
        max-height: 200px;
        object-fit: contain;
    }

    /* Preview Image */
    .preview-image {
        max-width: 300px;
        max-height: 300px;
        border-radius: 8px;
        object-fit: contain;
    }

    .btn-remove-preview {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(220, 53, 69, 0.9);
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-remove-preview:hover {
        background: #dc3545;
        transform: scale(1.1);
    }

    /* Form Styling */
    .comment-form textarea {
        border-radius: 8px;
        resize: vertical;
        min-height: 100px;
    }

    /* Custom Scrollbar */
    .comments-scroll-box::-webkit-scrollbar {
        width: 8px;
    }

    .comments-scroll-box::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
    }

    .comments-scroll-box::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    .comments-scroll-box::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .preview-image {
            max-width: 100%;
        }
        
        .comment-img {
            max-width: 100%;
        }
    }

    /* Reaction Container */
    .reactions-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        padding: 0.5rem 0;
        border-top: 1px solid #eee;
    }

    /* Reaction Buttons */
    .btn-reaction {
        padding: 6px 12px;
        border-radius: 20px;
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        color: #2c3e50;
        font-weight: 500;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-reaction:hover {
        background: #e9ecef;
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-reaction i {
        font-size: 1rem;
    }

    /* Reaction Count */
    .reaction-count {
        font-size: 0.85rem;
        font-weight: 600;
        min-width: 20px;
        text-align: center;
    }

    /* Reaction Colors */
    .text-primary { color: #3498db; }  /* Like */
    .text-danger { color: #e74c3c; }   /* Love */
    .text-warning { color: #f1c40f; }  /* Haha */
    .text-purple { color: #9b59b6; }   /* Wow */
    .text-secondary { color: #95a5a6; } /* Sad */
    .text-orange { color: #e67e22; }   /* Angry */

    /* Comment Reactions (smaller size) */
    .comment-card .btn-reaction {
        padding: 4px 8px;
        font-size: 0.9rem;
    }

    .comment-card .btn-reaction i {
        font-size: 0.9rem;
    }

    .comment-card .reaction-count {
        font-size: 0.8rem;
    }

    /* Active State */
    .btn-reaction.active {
        background: #e9ecef;
        border-color: #3498db;
    }

    /* Hover Effects */
    .btn-reaction:hover i {
        transform: scale(1.1);
    }

    /* Mobile Responsiveness */
    @media (max-width: 576px) {
        .reactions-container {
            gap: 0.25rem;
        }
        
        .btn-reaction {
            padding: 4px 8px;
        }
    }

    /* Thread Header Styling */
    .thread-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
    }

    .card-title {
        color: #2c3e50;
        font-weight: 600;
        font-size: 1.5rem;
    }

    .thread-meta {
        font-size: 0.9rem;
        color: #6c757d;
    }

    .thread-meta a {
        color: #3498db;
    }

    .thread-meta a:hover {
        color: #2980b9;
    }

    /* Thread Content Styling */
    .thread-content {
        font-size: 1.1rem;
        line-height: 1.6;
    }

    .content-text {
        white-space: pre-line;
    }

    .thread-image img {
        max-height: 500px;
        width: auto;
        object-fit: contain;
        border: 1px solid #eee;
    }

    /* Add these styles */
    .btn-back {
        background: linear-gradient(45deg, #2c3e50, #3498db);
        color: white;
        padding: 10px 24px;
        border-radius: 25px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .btn-back:hover {
        background: linear-gradient(45deg, #34495e, #2980b9);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .btn-back i {
        transition: transform 0.3s ease;
    }

    .btn-back:hover i {
        transform: translateX(-4px);
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
        .btn-back {
            width: 100%;
            margin-bottom: 1rem;
        }
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize popovers
    const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    const popoverList = popoverTriggerList.map(function (popoverTriggerEl) {
        return new bootstrap.Popover(popoverTriggerEl, {
            trigger: 'click',
            container: 'body'
        });
    });

    // Close popovers when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.matches('[data-bs-toggle="popover"]') && 
            !e.target.closest('.popover')) {
            popoverList.forEach(popover => popover.hide());
        }
    });
});

function previewImage(event) {
    const container = document.getElementById('image-preview-container');
    const preview = document.getElementById('image-preview');
    const file = event.target.files[0];
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            preview.src = e.target.result;
            container.classList.remove('d-none');
            // Scroll to show preview
            container.scrollIntoView({ behavior: 'smooth' });
        }
        reader.readAsDataURL(file);
    }
}

function removePreview() {
    const container = document.getElementById('image-preview-container');
    const input = document.getElementById('image');
    container.classList.add('d-none');
    input.value = '';
}

// Image click to view full size
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('comment-image')) {
        window.open(e.target.src, '_blank');
    }
});
</script>
{% endblock %}
